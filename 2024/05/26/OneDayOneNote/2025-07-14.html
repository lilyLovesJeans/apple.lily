<hr>
<h2 id="title-2025-07-14-Line-è¨‚å–®ç³»çµ±-C-éšæ®µ-ã€ŒLINE-è¨‚å–®æ•´åˆã€date-2025-11-13-23-28-09categories-OneDayOneNotetags-OneNote-Lineè¨‚å–®ç³»çµ±-description-2025-07-14-Line-è¨‚å–®ç³»çµ±-C-éšæ®µ-ã€ŒLINE-è¨‚å–®æ•´åˆã€"><a href="#title-2025-07-14-Line-è¨‚å–®ç³»çµ±-C-éšæ®µ-ã€ŒLINE-è¨‚å–®æ•´åˆã€date-2025-11-13-23-28-09categories-OneDayOneNotetags-OneNote-Lineè¨‚å–®ç³»çµ±-description-2025-07-14-Line-è¨‚å–®ç³»çµ±-C-éšæ®µ-ã€ŒLINE-è¨‚å–®æ•´åˆã€" class="headerlink" title="title: 2025-07-14 Line è¨‚å–®ç³»çµ±-C éšæ®µ ã€ŒLINE è¨‚å–®æ•´åˆã€date: 2025-11-13 23:28:09categories: OneDayOneNotetags:  [OneNote, Lineè¨‚å–®ç³»çµ±]description: 2025-07-14 Line è¨‚å–®ç³»çµ±-C éšæ®µ ã€ŒLINE è¨‚å–®æ•´åˆã€"></a>title: 2025-07-14 Line è¨‚å–®ç³»çµ±-C éšæ®µ ã€ŒLINE è¨‚å–®æ•´åˆã€<br>date: 2025-11-13 23:28:09<br>categories: OneDayOneNote<br>tags:  [OneNote, Lineè¨‚å–®ç³»çµ±]<br>description: 2025-07-14 Line è¨‚å–®ç³»çµ±-C éšæ®µ ã€ŒLINE è¨‚å–®æ•´åˆã€</h2><h2 id="2025-07-14-Line-è¨‚å–®ç³»çµ±-C-éšæ®µ-ã€ŒLINE-è¨‚å–®æ•´åˆã€"><a href="#2025-07-14-Line-è¨‚å–®ç³»çµ±-C-éšæ®µ-ã€ŒLINE-è¨‚å–®æ•´åˆã€" class="headerlink" title="2025-07-14 Line è¨‚å–®ç³»çµ±-C éšæ®µ ã€ŒLINE è¨‚å–®æ•´åˆã€"></a>2025-07-14 Line è¨‚å–®ç³»çµ±-C éšæ®µ ã€ŒLINE è¨‚å–®æ•´åˆã€</h2><p>ã€ŒLINE è¨‚å–®æ•´åˆã€</p>
<p> â€” é€™ä¸€æ­¥æ˜¯æ•´å€‹ <strong>ğŸ“˜ C éšæ®µã€ŒLINE è¨‚å–®æ•´åˆã€</strong> çš„æœ€é—œéµéƒ¨åˆ†ã€‚<br>å®Œæˆé€™ä¸€æ­¥å¾Œï¼Œä½ çš„ç³»çµ±å°±èƒ½åšåˆ°ä»¥ä¸‹å®Œæ•´æµç¨‹ï¼š</p>
<blockquote>
<p>LINE ä½¿ç”¨è€…è¼¸å…¥ï¼šã€Œè³¼è²· 1ã€ â†’<br>Node.js webhook æ¥æ”¶ â†’<br>å»ºç«‹æ–°è¨‚å–® â†’<br>å„²å­˜åˆ° MySQL â†’<br>Vue3 å¾Œå°å¯ç«‹å³çœ‹åˆ°æ–°è¨‚å–®ã€‚</p>
</blockquote>
<hr>
<h2 id="âœ…-ä¸€ã€ç›®æ¨™èªªæ˜"><a href="#âœ…-ä¸€ã€ç›®æ¨™èªªæ˜" class="headerlink" title="âœ… ä¸€ã€ç›®æ¨™èªªæ˜"></a>âœ… ä¸€ã€ç›®æ¨™èªªæ˜</h2><p>ç›®å‰ä½ å·²æœ‰å…©å€‹å¾Œç«¯æª”æ¡ˆï¼š</p>
<ul>
<li><code>lineWebhook.js</code> â†’ æ¥æ”¶ LINE è¨Šæ¯äº‹ä»¶</li>
<li><code>orders.js</code> â†’ æä¾› <code>/api/orders</code> æ–°å¢èˆ‡æŸ¥è©¢</li>
</ul>
<p>ç¾åœ¨æˆ‘å€‘è¦ï¼š</p>
<blockquote>
<p><strong>è®“ webhook åœ¨ä½¿ç”¨è€…è¼¸å…¥ã€Œè³¼è²· [å•†å“ID]ã€æ™‚è‡ªå‹•å‘¼å« <code>/api/orders</code> æ–°å¢è¨‚å–®ã€‚</strong></p>
</blockquote>
<hr>
<h2 id="ğŸ§©-äºŒã€ä¿®æ”¹æª”æ¡ˆï¼šbackend-routes-lineWebhook-js"><a href="#ğŸ§©-äºŒã€ä¿®æ”¹æª”æ¡ˆï¼šbackend-routes-lineWebhook-js" class="headerlink" title="ğŸ§© äºŒã€ä¿®æ”¹æª”æ¡ˆï¼šbackend/routes/lineWebhook.js"></a>ğŸ§© äºŒã€ä¿®æ”¹æª”æ¡ˆï¼š<code>backend/routes/lineWebhook.js</code></h2><p>é€™ä»½ç‰ˆæœ¬æ•´åˆäº†ï¼š</p>
<ul>
<li>ã€ŒæŸ¥è©¢å•†å“ã€(<code>å•†å“ 1</code>)</li>
<li>ã€Œè³¼è²·å•†å“ã€(<code>è³¼è²· 1</code>)<br>å…©ç¨®æŒ‡ä»¤ã€‚</li>
</ul>
<p>ç•¶ä½¿ç”¨è€…è¼¸å…¥ã€Œè³¼è²· 1ã€æ™‚ï¼Œå¾Œç«¯æœƒï¼š<br>1ï¸âƒ£ å¾ MySQL æŸ¥è©¢å•†å“è³‡è¨Šï¼›<br>2ï¸âƒ£ å»ºç«‹æ–°è¨‚å–®ï¼ˆå¯«å…¥ <code>orders</code> è¡¨ï¼‰ï¼›<br>3ï¸âƒ£ å›è¦†ä½¿ç”¨è€…ã€Œè¨‚å–®å»ºç«‹æˆåŠŸã€è¨Šæ¯ã€‚</p>
<hr>
<h3 id="ğŸ”§-æ›´æ–°å¾Œå®Œæ•´ç¨‹å¼ï¼š"><a href="#ğŸ”§-æ›´æ–°å¾Œå®Œæ•´ç¨‹å¼ï¼š" class="headerlink" title="ğŸ”§ æ›´æ–°å¾Œå®Œæ•´ç¨‹å¼ï¼š"></a>ğŸ”§ æ›´æ–°å¾Œå®Œæ•´ç¨‹å¼ï¼š</h3><pre><code class="js">// backend/routes/lineWebhook.js
import express from &quot;express&quot;;
import axios from &quot;axios&quot;;
import crypto from &quot;crypto&quot;;
import mysql from &quot;mysql2/promise&quot;;

const router = express.Router();

// å»ºç«‹ MySQL é€£ç·šæ± 
const pool = mysql.createPool({
  host: process.env.DB_HOST,
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  database: process.env.DB_NAME,
});

// é©—è­‰ LINE webhook ç°½ç« 
function validateSignature(body, signature) {
  const hash = crypto
    .createHmac(&quot;SHA256&quot;, process.env.LINE_CHANNEL_SECRET)
    .update(JSON.stringify(body))
    .digest(&quot;base64&quot;);
  return hash === signature;
}

// è™•ç† Webhook
router.post(&quot;/webhook&quot;, async (req, res) =&gt; {
  const signature = req.headers[&quot;x-line-signature&quot;];
  if (!validateSignature(req.body, signature)) {
    return res.status(401).send(&quot;Invalid signature&quot;);
  }

  const events = req.body.events;
  for (const event of events) {
    if (event.type === &quot;message&quot; &amp;&amp; event.message.type === &quot;text&quot;) {
      const userText = event.message.text.trim();
      const userName = event.source.userId || &quot;LINEä½¿ç”¨è€…&quot;;

      let replyMessage = &quot;&quot;;

      // ğŸŸ¢ 1ï¸âƒ£ æŸ¥è©¢å•†å“
      if (userText.startsWith(&quot;å•†å“&quot;)) {
        const itemCode = userText.replace(&quot;å•†å“&quot;, &quot;&quot;).trim();
        const [rows] = await pool.query(
          &quot;SELECT name, price, description FROM products WHERE id = ?&quot;,
          [itemCode]
        );

        if (rows.length &gt; 0) {
          const p = rows[0];
          replyMessage = `ğŸ“¦ å•†å“åç¨±ï¼š${p.name}\nğŸ’² åƒ¹æ ¼ï¼š${p.price}\nğŸ“ èªªæ˜ï¼š${p.description}\n\nè‹¥è¦ä¸‹å–®ï¼Œè«‹è¼¸å…¥ï¼šè³¼è²· ${itemCode}`;
        } else {
          replyMessage = &quot;æŸ¥ç„¡æ­¤å•†å“ï¼Œè«‹ç¢ºèªä»£è™Ÿæ˜¯å¦æ­£ç¢ºã€‚&quot;;
        }
      }

      // ğŸŸ  2ï¸âƒ£ è³¼è²·å•†å“
      else if (userText.startsWith(&quot;è³¼è²·&quot;)) {
        const itemCode = userText.replace(&quot;è³¼è²·&quot;, &quot;&quot;).trim();

        // æª¢æŸ¥å•†å“æ˜¯å¦å­˜åœ¨
        const [rows] = await pool.query(
          &quot;SELECT name, price FROM products WHERE id = ?&quot;,
          [itemCode]
        );

        if (rows.length === 0) {
          replyMessage = &quot;æ‰¾ä¸åˆ°è©²å•†å“ï¼Œè«‹ç¢ºèªä»£è™Ÿã€‚&quot;;
        } else {
          // æ–°å¢è¨‚å–®
          await pool.query(
            `INSERT INTO orders (user_name, product_id, quantity, status, created_at)
             VALUES (?, ?, 1, &#39;æ–°è¨‚å–®&#39;, NOW())`,
            [userName, itemCode]
          );

          const product = rows[0];
          replyMessage = `âœ… å·²å»ºç«‹è¨‚å–®ï¼š${product.name}\nğŸ’² åƒ¹æ ¼ï¼š${product.price}\nğŸ“¦ ç‹€æ…‹ï¼šæ–°è¨‚å–®`;
        }
      }

      // ğŸ”µ å…¶ä»–è¨Šæ¯
      else {
        replyMessage =
          &quot;æ‚¨å¥½ï¼è«‹è¼¸å…¥ï¼š\nã€Œå•†å“ 1ã€æŸ¥è©¢å•†å“\næˆ–ã€Œè³¼è²· 1ã€ç›´æ¥ä¸‹å–®ã€‚&quot;;
      }

      // å›è¦† LINE è¨Šæ¯
      await axios.post(
        &quot;https://api.line.me/v2/bot/message/reply&quot;,
        {
          replyToken: event.replyToken,
          messages: [{ type: &quot;text&quot;, text: replyMessage }],
        },
        {
          headers: {
            &quot;Content-Type&quot;: &quot;application/json&quot;,
            Authorization: `Bearer ${process.env.LINE_CHANNEL_ACCESS_TOKEN}`,
          },
        }
      );
    }
  }

  res.status(200).end();
});

export default router;
</code></pre>
<hr>
<h2 id="ğŸ—‚ï¸-è³‡æ–™åº«ç¢ºèª"><a href="#ğŸ—‚ï¸-è³‡æ–™åº«ç¢ºèª" class="headerlink" title="ğŸ—‚ï¸ è³‡æ–™åº«ç¢ºèª"></a>ğŸ—‚ï¸ è³‡æ–™åº«ç¢ºèª</h2><p>è«‹ç¢ºèª <code>orders</code> è¡¨å·²å­˜åœ¨ï¼Œçµæ§‹å¦‚ä¸‹ï¼š</p>
<pre><code class="sql">CREATE TABLE orders (
  id INT AUTO_INCREMENT PRIMARY KEY,
  user_name VARCHAR(100),
  product_id INT,
  quantity INT DEFAULT 1,
  status VARCHAR(50) DEFAULT &#39;æ–°è¨‚å–®&#39;,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (product_id) REFERENCES products(id)
);
</code></pre>
<hr>
<h2 id="âš™ï¸-æ¸¬è©¦æµç¨‹"><a href="#âš™ï¸-æ¸¬è©¦æµç¨‹" class="headerlink" title="âš™ï¸ æ¸¬è©¦æµç¨‹"></a>âš™ï¸ æ¸¬è©¦æµç¨‹</h2><table>
<thead>
<tr>
<th>æ­¥é©Ÿ</th>
<th>å‹•ä½œ</th>
<th>é æœŸçµæœ</th>
</tr>
</thead>
<tbody><tr>
<td>1ï¸âƒ£</td>
<td>å•Ÿå‹•å¾Œç«¯ä¼ºæœå™¨ (<code>npm run dev</code>)</td>
<td>ä¼ºæœå™¨é‹è¡Œæ–¼ <a href="http://localhost:3000/">http://localhost:3000</a></td>
</tr>
<tr>
<td>2ï¸âƒ£</td>
<td>ä½¿ç”¨ ngrok å°å¤–å…¬é–‹</td>
<td><code>ngrok http 3000</code></td>
</tr>
<tr>
<td>3ï¸âƒ£</td>
<td>åœ¨ LINE Developers Webhook URL è¨­ç‚º <code>https://&lt;ngrok-url&gt;/api/webhook</code></td>
<td>æˆåŠŸè¨­å®š Webhook</td>
</tr>
<tr>
<td>4ï¸âƒ£</td>
<td>åœ¨ LINE è¼¸å…¥ã€Œå•†å“ 1ã€</td>
<td>Bot å›è¦†å•†å“è³‡è¨Š</td>
</tr>
<tr>
<td>5ï¸âƒ£</td>
<td>åœ¨ LINE è¼¸å…¥ã€Œè³¼è²· 1ã€</td>
<td>Bot å›è¦†ã€Œå·²å»ºç«‹è¨‚å–®ã€ï¼ŒåŒæ™‚ MySQL å¯«å…¥æ–°è¨‚å–®</td>
</tr>
<tr>
<td>6ï¸âƒ£</td>
<td>åœ¨ Vue3 å¾Œå°ã€ŒLINE è¨‚å–®ç´€éŒ„ã€é é¢æŸ¥çœ‹</td>
<td>å¯çœ‹åˆ°å‰›å‰›å»ºç«‹çš„è¨‚å–®ç´€éŒ„</td>
</tr>
</tbody></table>
<hr>
<h2 id="ğŸ’¡-å»¶ä¼¸å»ºè­°ï¼ˆC-éšæ®µå®Œæˆå¾Œçš„ä¸‹ä¸€æ­¥ï¼‰"><a href="#ğŸ’¡-å»¶ä¼¸å»ºè­°ï¼ˆC-éšæ®µå®Œæˆå¾Œçš„ä¸‹ä¸€æ­¥ï¼‰" class="headerlink" title="ğŸ’¡ å»¶ä¼¸å»ºè­°ï¼ˆC éšæ®µå®Œæˆå¾Œçš„ä¸‹ä¸€æ­¥ï¼‰"></a>ğŸ’¡ å»¶ä¼¸å»ºè­°ï¼ˆC éšæ®µå®Œæˆå¾Œçš„ä¸‹ä¸€æ­¥ï¼‰</h2><p>å®Œæˆé€™éƒ¨åˆ†å¾Œï¼Œä½ çš„ç³»çµ±å·²ç¶“å…·å‚™ï¼š<br>âœ… å•†å“æŸ¥è©¢<br>âœ… ä¸‹å–®åŠŸèƒ½<br>âœ… å¾Œå°æŸ¥è©¢</p>
<p>æ¥ä¸‹ä¾†å¯ä»¥é€²å…¥ <strong>ğŸ“’ D éšæ®µï¼šRedis å³æ™‚å¿«å– + è¨‚å–®é€šçŸ¥ç³»çµ±</strong>ï¼Œ<br>è®“è¨‚å–®ç‹€æ…‹ï¼ˆä¾‹å¦‚ã€Œå·²æ¥å–®ã€ã€ã€Œé…é€ä¸­ã€ï¼‰èƒ½å³æ™‚æ›´æ–°å‰ç«¯ç•«é¢æˆ–æ¨æ’­åˆ° LINEã€‚</p>
<hr>
<p>æ˜¯å¦è¦æˆ‘å¹«ä½ ç¹¼çºŒé€²å…¥ ğŸ“’ <strong>D éšæ®µ â€” Redis å¿«å–èˆ‡è¨‚å–®ç‹€æ…‹é€šçŸ¥è¨­è¨ˆèˆ‡å¯¦ä½œ</strong>ï¼Ÿ</p>
