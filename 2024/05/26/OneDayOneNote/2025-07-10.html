<hr>
<h2 id="title-2025-07-10-Line-è¨‚å–®ç³»çµ±-C-éšæ®µ-å»ºç«‹-Node-js-å°ˆæ¡ˆçš„ä¸‰å€‹æ ¸å¿ƒæª”æ¡ˆconfig-db-orderRoutesdate-2025-11-13-22-41-28categories-OneDayOneNotetags-OneNote-Lineè¨‚å–®ç³»çµ±-description-2025-07-10-Line-è¨‚å–®ç³»çµ±-C-éšæ®µ-å»ºç«‹-Node-js-å°ˆæ¡ˆçš„ä¸‰å€‹æ ¸å¿ƒæª”æ¡ˆconfig-db-orderRoutes"><a href="#title-2025-07-10-Line-è¨‚å–®ç³»çµ±-C-éšæ®µ-å»ºç«‹-Node-js-å°ˆæ¡ˆçš„ä¸‰å€‹æ ¸å¿ƒæª”æ¡ˆconfig-db-orderRoutesdate-2025-11-13-22-41-28categories-OneDayOneNotetags-OneNote-Lineè¨‚å–®ç³»çµ±-description-2025-07-10-Line-è¨‚å–®ç³»çµ±-C-éšæ®µ-å»ºç«‹-Node-js-å°ˆæ¡ˆçš„ä¸‰å€‹æ ¸å¿ƒæª”æ¡ˆconfig-db-orderRoutes" class="headerlink" title="title: 2025-07-10 Line è¨‚å–®ç³»çµ±-C éšæ®µ å»ºç«‹ Node.js å°ˆæ¡ˆçš„ä¸‰å€‹æ ¸å¿ƒæª”æ¡ˆconfig db orderRoutesdate: 2025-11-13 22:41:28categories: OneDayOneNotetags:  [OneNote, Lineè¨‚å–®ç³»çµ±]description: 2025-07-10 Line è¨‚å–®ç³»çµ±-C éšæ®µ å»ºç«‹ Node.js å°ˆæ¡ˆçš„ä¸‰å€‹æ ¸å¿ƒæª”æ¡ˆconfig db orderRoutes"></a>title: 2025-07-10 Line è¨‚å–®ç³»çµ±-C éšæ®µ å»ºç«‹ Node.js å°ˆæ¡ˆçš„ä¸‰å€‹æ ¸å¿ƒæª”æ¡ˆconfig db orderRoutes<br>date: 2025-11-13 22:41:28<br>categories: OneDayOneNote<br>tags:  [OneNote, Lineè¨‚å–®ç³»çµ±]<br>description: 2025-07-10 Line è¨‚å–®ç³»çµ±-C éšæ®µ å»ºç«‹ Node.js å°ˆæ¡ˆçš„ä¸‰å€‹æ ¸å¿ƒæª”æ¡ˆconfig db orderRoutes</h2><h2 id="2025-07-10-å»ºç«‹-Node-js-å°ˆæ¡ˆçš„ä¸‰å€‹æ ¸å¿ƒæª”æ¡ˆconfig-db-orderRoutes"><a href="#2025-07-10-å»ºç«‹-Node-js-å°ˆæ¡ˆçš„ä¸‰å€‹æ ¸å¿ƒæª”æ¡ˆconfig-db-orderRoutes" class="headerlink" title="2025-07-10 å»ºç«‹ Node.js å°ˆæ¡ˆçš„ä¸‰å€‹æ ¸å¿ƒæª”æ¡ˆconfig db orderRoutes"></a>2025-07-10 å»ºç«‹ Node.js å°ˆæ¡ˆçš„ä¸‰å€‹æ ¸å¿ƒæª”æ¡ˆconfig db orderRoutes</h2><p>ç¾åœ¨æˆ‘å€‘è¦æ­£å¼å»ºç«‹ Node.js å°ˆæ¡ˆçš„ä¸‰å€‹æ ¸å¿ƒæª”æ¡ˆï¼š</p>
<blockquote>
<p>ğŸ“‚ <code>/backend/config.js</code><br>ğŸ“‚ <code>/backend/db.js</code><br>ğŸ“‚ <code>/backend/routes/orderRoutes.js</code></p>
</blockquote>
<p>é€™ä¸‰å€‹æª”æ¡ˆçš„ä½œç”¨å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>æª”æ¡ˆ</th>
<th>åŠŸèƒ½</th>
</tr>
</thead>
<tbody><tr>
<td><code>config.js</code></td>
<td>è¼‰å…¥ <code>.env</code> ä¸¦é›†ä¸­ç®¡ç†ç’°å¢ƒè®Šæ•¸</td>
</tr>
<tr>
<td><code>db.js</code></td>
<td>é€£ç·š MySQLï¼ˆç”¨ <code>mysql2</code> æˆ– <code>sequelize</code>ï¼‰</td>
</tr>
<tr>
<td><code>orderRoutes.js</code></td>
<td>æä¾›åŸºæœ¬è¨‚å–® APIï¼ˆæŸ¥è©¢ã€å»ºç«‹ã€æ›´æ–°ï¼‰</td>
</tr>
</tbody></table>
<hr>
<h2 id="ğŸ§©-ä¸€ã€config-js"><a href="#ğŸ§©-ä¸€ã€config-js" class="headerlink" title="ğŸ§© ä¸€ã€config.js"></a>ğŸ§© ä¸€ã€<code>config.js</code></h2><blockquote>
<p>ğŸ“ è·¯å¾‘ï¼š<code>/backend/config.js</code></p>
</blockquote>
<pre><code class="js">// ===============================
// ğŸ“˜ config.js
// è®€å– .env ä¸¦çµ±ä¸€ç®¡ç†ç³»çµ±è¨­å®š
// ===============================
import dotenv from &quot;dotenv&quot;;
dotenv.config();

export const config = {
  env: process.env.NODE_ENV || &quot;development&quot;,
  port: process.env.PORT || 3000,

  // Database
  db: {
    host: process.env.DB_HOST,
    port: process.env.DB_PORT,
    user: process.env.DB_USER,
    password: process.env.DB_PASSWORD,
    name: process.env.DB_NAME,
  },

  // LINE
  line: {
    channelSecret: process.env.LINE_CHANNEL_SECRET,
    channelAccessToken: process.env.LINE_CHANNEL_ACCESS_TOKEN,
    webhookPath: process.env.LINE_WEBHOOK_PATH,
  },

  // JWT
  jwt: {
    secret: process.env.JWT_SECRET,
    expiresIn: process.env.TOKEN_EXPIRE_DAYS || &quot;7d&quot;,
  },

  // Optional
  redis: {
    host: process.env.REDIS_HOST,
    port: process.env.REDIS_PORT,
  },
};

export default config;
</code></pre>
<hr>
<h2 id="ğŸ§ -äºŒã€db-js"><a href="#ğŸ§ -äºŒã€db-js" class="headerlink" title="ğŸ§  äºŒã€db.js"></a>ğŸ§  äºŒã€<code>db.js</code></h2><blockquote>
<p>ğŸ“ è·¯å¾‘ï¼š<code>/backend/db.js</code></p>
</blockquote>
<p>é€™å€‹æª”æ¡ˆæœƒä½¿ç”¨ <code>mysql2</code> å¥—ä»¶é€£ç·šè³‡æ–™åº«ã€‚<br>è«‹å…ˆåœ¨å¾Œç«¯å°ˆæ¡ˆä¸­åŸ·è¡Œå®‰è£ï¼š</p>
<pre><code class="bash">npm install mysql2
</code></pre>
<p>æ¥è‘—å»ºç«‹æª”æ¡ˆå…§å®¹ğŸ‘‡</p>
<pre><code class="js">// ===============================
// ğŸ—„ï¸ db.js
// å»ºç«‹ MySQL è³‡æ–™åº«é€£ç·š
// ===============================
import mysql from &quot;mysql2/promise&quot;;
import config from &quot;./config.js&quot;;

let pool;

export async function initDB() {
  if (!pool) {
    pool = mysql.createPool({
      host: config.db.host,
      user: config.db.user,
      password: config.db.password,
      database: config.db.name,
      port: config.db.port,
      waitForConnections: true,
      connectionLimit: 10,
      queueLimit: 0,
    });
    console.log(&quot;âœ… MySQL connection pool created&quot;);
  }
  return pool;
}

export async function query(sql, params = []) {
  const connection = await initDB();
  const [rows] = await connection.execute(sql, params);
  return rows;
}

// ğŸ” æ¸¬è©¦é€£ç·š
if (process.env.NODE_ENV === &quot;development&quot;) {
  initDB()
    .then(() =&gt; console.log(&quot;âœ… DB connected successfully&quot;))
    .catch((err) =&gt; console.error(&quot;âŒ DB connection error:&quot;, err.message));
}
</code></pre>
<hr>
<h2 id="ğŸ“¦-ä¸‰ã€routes-orderRoutes-js"><a href="#ğŸ“¦-ä¸‰ã€routes-orderRoutes-js" class="headerlink" title="ğŸ“¦ ä¸‰ã€routes/orderRoutes.js"></a>ğŸ“¦ ä¸‰ã€<code>routes/orderRoutes.js</code></h2><blockquote>
<p>ğŸ“ è·¯å¾‘ï¼š<code>/backend/routes/orderRoutes.js</code></p>
</blockquote>
<p>è«‹å…ˆå®‰è£ Expressï¼š</p>
<pre><code class="bash">npm install express
</code></pre>
<p>ç„¶å¾Œå»ºç«‹ä»¥ä¸‹å…§å®¹ï¼š</p>
<pre><code class="js">// ===============================
// ğŸ§¾ orderRoutes.js
// è¨‚å–®ç›¸é—œ APIï¼šæŸ¥è©¢ã€å»ºç«‹ã€æ›´æ–°
// ===============================
import express from &quot;express&quot;;
import { query } from &quot;../db.js&quot;;

const router = express.Router();

// âœ… GET /api/orders - å–å¾—æ‰€æœ‰è¨‚å–®
router.get(&quot;/&quot;, async (req, res) =&gt; {
  try {
    const orders = await query(
      &quot;SELECT o.id, u.display_name AS user_name, o.total_price, o.status, o.created_at FROM orders o JOIN users u ON o.user_id = u.id ORDER BY o.id DESC&quot;
    );
    res.json(orders);
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: &quot;Server error while fetching orders&quot; });
  }
});

// âœ… POST /api/orders - å»ºç«‹æ–°è¨‚å–®
router.post(&quot;/&quot;, async (req, res) =&gt; {
  try {
    const { user_id, items } = req.body;

    // è¨ˆç®—ç¸½é‡‘é¡
    let total = 0;
    for (const item of items) {
      total += item.price * item.quantity;
    }

    // æ–°å¢è¨‚å–®
    const result = await query(
      &quot;INSERT INTO orders (user_id, total_price, status) VALUES (?, ?, &#39;pending&#39;)&quot;,
      [user_id, total]
    );
    const orderId = result.insertId;

    // æ–°å¢è¨‚å–®æ˜ç´°
    for (const item of items) {
      await query(
        &quot;INSERT INTO order_items (order_id, product_id, quantity, price) VALUES (?, ?, ?, ?)&quot;,
        [orderId, item.product_id, item.quantity, item.price]
      );
    }

    res.status(201).json({ message: &quot;Order created successfully&quot;, orderId });
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: &quot;Server error while creating order&quot; });
  }
});

// âœ… PATCH /api/orders/:id - æ›´æ–°è¨‚å–®ç‹€æ…‹
router.patch(&quot;/:id&quot;, async (req, res) =&gt; {
  try {
    const { status } = req.body;
    const orderId = req.params.id;

    await query(&quot;UPDATE orders SET status = ? WHERE id = ?&quot;, [status, orderId]);
    res.json({ message: &quot;Order status updated&quot; });
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: &quot;Failed to update order&quot; });
  }
});

export default router;
</code></pre>
<hr>
<h2 id="ğŸ§­-å››ã€æ•´åˆé€²ä¸»ä¼ºæœå™¨"><a href="#ğŸ§­-å››ã€æ•´åˆé€²ä¸»ä¼ºæœå™¨" class="headerlink" title="ğŸ§­ å››ã€æ•´åˆé€²ä¸»ä¼ºæœå™¨"></a>ğŸ§­ å››ã€æ•´åˆé€²ä¸»ä¼ºæœå™¨</h2><p>ä½ çš„ <code>server.js</code>ï¼ˆæˆ– <code>index.js</code>ï¼‰ å¯ä»¥é€™æ¨£è¨­å®šï¼š</p>
<pre><code class="js">import express from &quot;express&quot;;
import cors from &quot;cors&quot;;
import orderRoutes from &quot;./routes/orderRoutes.js&quot;;
import { initDB } from &quot;./db.js&quot;;
import config from &quot;./config.js&quot;;

const app = express();
app.use(cors());
app.use(express.json());

// âœ… è¨»å†Šè·¯ç”±
app.use(&quot;/api/orders&quot;, orderRoutes);

// âœ… å•Ÿå‹•ä¼ºæœå™¨
initDB().then(() =&gt; {
  app.listen(config.port, () =&gt; {
    console.log(`ğŸš€ Server running on http://localhost:${config.port}`);
  });
});
</code></pre>
<hr>
<h2 id="âœ…-æ¸¬è©¦ç¯„ä¾‹"><a href="#âœ…-æ¸¬è©¦ç¯„ä¾‹" class="headerlink" title="âœ… æ¸¬è©¦ç¯„ä¾‹"></a>âœ… æ¸¬è©¦ç¯„ä¾‹</h2><h3 id="1ï¸âƒ£-æŸ¥è©¢æ‰€æœ‰è¨‚å–®"><a href="#1ï¸âƒ£-æŸ¥è©¢æ‰€æœ‰è¨‚å–®" class="headerlink" title="1ï¸âƒ£ æŸ¥è©¢æ‰€æœ‰è¨‚å–®"></a>1ï¸âƒ£ æŸ¥è©¢æ‰€æœ‰è¨‚å–®</h3><pre><code>GET http://localhost:3000/api/orders
</code></pre>
<h3 id="2ï¸âƒ£-å»ºç«‹è¨‚å–®"><a href="#2ï¸âƒ£-å»ºç«‹è¨‚å–®" class="headerlink" title="2ï¸âƒ£ å»ºç«‹è¨‚å–®"></a>2ï¸âƒ£ å»ºç«‹è¨‚å–®</h3><pre><code>POST http://localhost:3000/api/orders
Content-Type: application/json

{
  &quot;user_id&quot;: 1,
  &quot;items&quot;: [
    { &quot;product_id&quot;: 1, &quot;quantity&quot;: 2, &quot;price&quot;: 80 },
    { &quot;product_id&quot;: 2, &quot;quantity&quot;: 1, &quot;price&quot;: 60 }
  ]
}
</code></pre>
<h3 id="3ï¸âƒ£-æ›´æ–°è¨‚å–®ç‹€æ…‹"><a href="#3ï¸âƒ£-æ›´æ–°è¨‚å–®ç‹€æ…‹" class="headerlink" title="3ï¸âƒ£ æ›´æ–°è¨‚å–®ç‹€æ…‹"></a>3ï¸âƒ£ æ›´æ–°è¨‚å–®ç‹€æ…‹</h3><pre><code>PATCH http://localhost:3000/api/orders/1
Content-Type: application/json

{ &quot;status&quot;: &quot;paid&quot; }
</code></pre>
<hr>
<p>å¦‚æœä½ é¡˜æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥å¹«ä½ å»ºç«‹ï¼š</p>
<blockquote>
<p>ğŸ“˜ <code>routes/productRoutes.js</code><br>ğŸ“˜ <code>routes/userRoutes.js</code><br>ğŸ“˜ <code>routes/lineWebhook.js</code>ï¼ˆè®“ LINE Bot èƒ½é€£æ¥é€™å€‹è¨‚å–® APIï¼‰</p>
</blockquote>
<p>æ˜¯å¦è¦æˆ‘æ¥ä¸‹ä¾†å¹«ä½ ç”Ÿæˆé€™ä¸‰å€‹æª”æ¡ˆï¼Ÿ</p>
