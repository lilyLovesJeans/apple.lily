<hr>
<h2 id="title-2025-07-08-Line-è¨‚å–®ç³»çµ±-C-éšæ®µç¨‹å¼ç¯„ä¾‹date-2025-11-12-23-25-03categories-OneDayOneNotetags-OneNote-Lineè¨‚å–®ç³»çµ±-description-2025-07-08-Line-è¨‚å–®ç³»çµ±-C-éšæ®µç¨‹å¼ç¯„ä¾‹"><a href="#title-2025-07-08-Line-è¨‚å–®ç³»çµ±-C-éšæ®µç¨‹å¼ç¯„ä¾‹date-2025-11-12-23-25-03categories-OneDayOneNotetags-OneNote-Lineè¨‚å–®ç³»çµ±-description-2025-07-08-Line-è¨‚å–®ç³»çµ±-C-éšæ®µç¨‹å¼ç¯„ä¾‹" class="headerlink" title="title: 2025-07-08 Line è¨‚å–®ç³»çµ±-C éšæ®µç¨‹å¼ç¯„ä¾‹date: 2025-11-12 23:25:03categories: OneDayOneNotetags:  [OneNote, Lineè¨‚å–®ç³»çµ±]description:  2025-07-08 Line è¨‚å–®ç³»çµ±-C éšæ®µç¨‹å¼ç¯„ä¾‹"></a>title: 2025-07-08 Line è¨‚å–®ç³»çµ±-C éšæ®µç¨‹å¼ç¯„ä¾‹<br>date: 2025-11-12 23:25:03<br>categories: OneDayOneNote<br>tags:  [OneNote, Lineè¨‚å–®ç³»çµ±]<br>description:  2025-07-08 Line è¨‚å–®ç³»çµ±-C éšæ®µç¨‹å¼ç¯„ä¾‹</h2><h2 id="2025-07-08-Line-è¨‚å–®ç³»çµ±-C-éšæ®µç¨‹å¼ç¯„ä¾‹"><a href="#2025-07-08-Line-è¨‚å–®ç³»çµ±-C-éšæ®µç¨‹å¼ç¯„ä¾‹" class="headerlink" title="2025-07-08 Line è¨‚å–®ç³»çµ±-C éšæ®µç¨‹å¼ç¯„ä¾‹"></a>2025-07-08 Line è¨‚å–®ç³»çµ±-C éšæ®µç¨‹å¼ç¯„ä¾‹</h2><p>é€™ä¸‰ä»½æª”æ¡ˆï¼Œè¨­è¨ˆç‚º<strong>å¯ä»¥ç›´æ¥æ”¾é€²ä½ çš„ç¾æœ‰ LINE + Vue å¾Œå°å°ˆæ¡ˆä¸­åŸ·è¡Œ</strong>ï¼š</p>
<hr>
<h2 id="ğŸ“-ç›®éŒ„çµæ§‹ï¼ˆæ”¾ç½®èªªæ˜ï¼‰"><a href="#ğŸ“-ç›®éŒ„çµæ§‹ï¼ˆæ”¾ç½®èªªæ˜ï¼‰" class="headerlink" title="ğŸ“ ç›®éŒ„çµæ§‹ï¼ˆæ”¾ç½®èªªæ˜ï¼‰"></a>ğŸ“ ç›®éŒ„çµæ§‹ï¼ˆæ”¾ç½®èªªæ˜ï¼‰</h2><pre><code>project-root/
â”œâ”€ backend/
â”‚  â”œâ”€ routes/
â”‚  â”‚  â”œâ”€ line.js       â† (A) LINE webhook + è¨‚å–®å»ºç«‹æ•´åˆ
â”‚  â”‚  â”œâ”€ orders.js     â† (B) è¨‚å–® REST APIï¼ˆå«é€šçŸ¥åŠŸèƒ½ï¼‰
â”‚  â””â”€ db/
â”‚     â””â”€ seed_products.sql â† (C) å•†å“æ¸¬è©¦è³‡æ–™
â”‚
â””â”€ frontend/
   â””â”€ src/
      â””â”€ views/
         â””â”€ Orders.vue  â† (D) Vue å¾Œå°è¨‚å–®é 
</code></pre>
<hr>
<h1 id="ğŸ§©-A-backend-routes-line-js"><a href="#ğŸ§©-A-backend-routes-line-js" class="headerlink" title="ğŸ§© (A) backend/routes/line.js"></a>ğŸ§© (A) <code>backend/routes/line.js</code></h1><p>ğŸ‘‰ <strong>åŠŸèƒ½</strong>ï¼š<br>è™•ç†ã€Œæˆ‘è¦é»é¤ã€æ–‡å­—è¨Šæ¯ã€å›å‚³å•†å“ Flexã€æ¥æ”¶ postback è³¼è²·äº‹ä»¶ã€å»ºç«‹è¨‚å–®ã€é€šçŸ¥ç®¡ç†è€…ã€‚</p>
<pre><code class="js">// backend/routes/line.js
import express from &quot;express&quot;;
import { middleware, Client } from &quot;@line/bot-sdk&quot;;
import dotenv from &quot;dotenv&quot;;
import { pool } from &quot;../db.js&quot;;

dotenv.config();

const router = express.Router();

const config = {
  channelAccessToken: process.env.LINE_CHANNEL_ACCESS_TOKEN,
  channelSecret: process.env.LINE_CHANNEL_SECRET,
};
const client = new Client(config);

// --- LINE Webhook ä¸»å…¥å£ ---
router.post(&quot;/webhook&quot;, middleware(config), async (req, res) =&gt; {
  try {
    const events = req.body.events || [];

    for (const event of events) {
      // ğŸ¯ 1ï¸âƒ£ ä½¿ç”¨è€…å‚³æ–‡å­—ï¼šæˆ‘è¦é»é¤
      if (event.type === &quot;message&quot; &amp;&amp; event.message.type === &quot;text&quot;) {
        const text = event.message.text.trim();
        if (text === &quot;æˆ‘è¦é»é¤&quot; || text === &quot;é»é¤&quot;) {
          const [products] = await pool.query(
            &quot;SELECT id, name, price, description, image_url FROM products LIMIT 10&quot;
          );

          const bubbles = products.map((p) =&gt; ({
            type: &quot;bubble&quot;,
            hero: p.image_url
              ? {
                  type: &quot;image&quot;,
                  url: p.image_url,
                  size: &quot;full&quot;,
                  aspectRatio: &quot;20:13&quot;,
                  aspectMode: &quot;cover&quot;,
                }
              : undefined,
            body: {
              type: &quot;box&quot;,
              layout: &quot;vertical&quot;,
              contents: [
                { type: &quot;text&quot;, text: p.name, weight: &quot;bold&quot;, size: &quot;lg&quot; },
                { type: &quot;text&quot;, text: `åƒ¹æ ¼ï¼š$${p.price}`, size: &quot;sm&quot; },
                { type: &quot;text&quot;, text: p.description || &quot;&quot;, size: &quot;sm&quot;, wrap: true },
              ],
            },
            footer: {
              type: &quot;box&quot;,
              layout: &quot;vertical&quot;,
              contents: [
                {
                  type: &quot;button&quot;,
                  style: &quot;primary&quot;,
                  action: {
                    type: &quot;postback&quot;,
                    label: &quot;è³¼è²·&quot;,
                    data: `action=buy&amp;productId=${p.id}&amp;qty=1`,
                  },
                },
              ],
            },
          }));

          const flex = {
            type: &quot;carousel&quot;,
            contents: bubbles.length
              ? bubbles
              : [
                  {
                    type: &quot;bubble&quot;,
                    body: {
                      type: &quot;box&quot;,
                      layout: &quot;vertical&quot;,
                      contents: [{ type: &quot;text&quot;, text: &quot;ç›®å‰ç„¡å•†å“&quot; }],
                    },
                  },
                ],
          };

          await client.replyMessage(event.replyToken, {
            type: &quot;flex&quot;,
            altText: &quot;å•†å“åˆ—è¡¨&quot;,
            contents: flex,
          });
          continue;
        }

        // å…¶ä»–è¨Šæ¯å›è¦†
        await client.replyMessage(event.replyToken, {
          type: &quot;text&quot;,
          text: &quot;è«‹è¼¸å…¥ã€Œæˆ‘è¦é»é¤ã€é–‹å§‹ä¸‹å–®æµç¨‹ã€‚&quot;,
        });
      }

      // ğŸ¯ 2ï¸âƒ£ postback eventï¼ˆè³¼è²·å•†å“ï¼‰
      else if (event.type === &quot;postback&quot;) {
        const qs = new URLSearchParams(event.postback.data);
        const action = qs.get(&quot;action&quot;);
        if (action === &quot;buy&quot;) {
          const productId = parseInt(qs.get(&quot;productId&quot;));
          const qty = parseInt(qs.get(&quot;qty&quot;) || &quot;1&quot;);
          const userId = event.source.userId;

          const [[prod]] = await pool.query(
            &quot;SELECT id, name, price FROM products WHERE id = ?&quot;,
            [productId]
          );
          if (!prod) {
            await client.replyMessage(event.replyToken, {
              type: &quot;text&quot;,
              text: &quot;æ‰¾ä¸åˆ°è©²å•†å“ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚&quot;,
            });
            continue;
          }

          const conn = await pool.getConnection();
          try {
            await conn.beginTransaction();

            const subtotal = Number(prod.price) * qty;
            const orderNo = `L${Date.now().toString().slice(-6)}`;

            const [r] = await conn.query(
              &quot;INSERT INTO orders (order_no, user_line_id, total_price) VALUES (?, ?, ?)&quot;,
              [orderNo, userId, subtotal]
            );
            const orderId = r.insertId;

            await conn.query(
              &quot;INSERT INTO order_items (order_id, product_id, product_name, qty, unit_price, subtotal) VALUES (?, ?, ?, ?, ?, ?)&quot;,
              [orderId, prod.id, prod.name, qty, prod.price, subtotal]
            );

            await conn.commit();

            await client.replyMessage(event.replyToken, {
              type: &quot;text&quot;,
              text: `âœ… å·²å»ºç«‹è¨‚å–®\nç·¨è™Ÿï¼š${orderNo}\nå•†å“ï¼š${prod.name}\næ•¸é‡ï¼š${qty}\né‡‘é¡ï¼š$${subtotal}`,
            });

            // é€šçŸ¥ç®¡ç†è€…
            if (process.env.ADMIN_LINE_ID) {
              await client.pushMessage(process.env.ADMIN_LINE_ID, {
                type: &quot;text&quot;,
                text: `ğŸ“¦ æ–°è¨‚å–®ï¼š${orderNo}\nå•†å“ï¼š${prod.name} x${qty}`,
              });
            }
          } catch (err) {
            await conn.rollback();
            console.error(&quot;Create order failed:&quot;, err);
            await client.replyMessage(event.replyToken, {
              type: &quot;text&quot;,
              text: &quot;å»ºç«‹è¨‚å–®å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚&quot;,
            });
          } finally {
            conn.release();
          }
        }
      }
    }

    res.status(200).send(&quot;OK&quot;);
  } catch (err) {
    console.error(&quot;Webhook error:&quot;, err);
    res.status(500).end();
  }
});

export default router;
</code></pre>
<hr>
<h1 id="ğŸ§©-B-backend-routes-orders-js"><a href="#ğŸ§©-B-backend-routes-orders-js" class="headerlink" title="ğŸ§© (B) backend/routes/orders.js"></a>ğŸ§© (B) <code>backend/routes/orders.js</code></h1><p>ğŸ‘‰ <strong>åŠŸèƒ½</strong>ï¼š<br>æä¾› REST API çµ¦ Vue å¾Œå°ä½¿ç”¨ï¼ˆæŸ¥è©¢è¨‚å–®ã€ä¿®æ”¹ç‹€æ…‹ã€é€šçŸ¥è²·å®¶ï¼‰ã€‚</p>
<pre><code class="js">// backend/routes/orders.js
import express from &quot;express&quot;;
import { pool } from &quot;../db.js&quot;;
import { Client } from &quot;@line/bot-sdk&quot;;
import dotenv from &quot;dotenv&quot;;
dotenv.config();

const router = express.Router();

const client = new Client({
  channelAccessToken: process.env.LINE_CHANNEL_ACCESS_TOKEN,
});

// æŸ¥è©¢æ‰€æœ‰è¨‚å–®ï¼ˆå«æ˜ç´°ï¼‰
router.get(&quot;/&quot;, async (req, res) =&gt; {
  try {
    const [orders] = await pool.query(`
      SELECT o.*, (
        SELECT JSON_ARRAYAGG(
          JSON_OBJECT(
            &#39;product_id&#39;, oi.product_id,
            &#39;product_name&#39;, oi.product_name,
            &#39;qty&#39;, oi.qty,
            &#39;unit_price&#39;, oi.unit_price,
            &#39;subtotal&#39;, oi.subtotal
          )
        )
        FROM order_items oi WHERE oi.order_id = o.id
      ) AS items
      FROM orders o
      ORDER BY o.id DESC
    `);
    res.json(orders);
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: &quot;Server error&quot; });
  }
});

// ä¿®æ”¹è¨‚å–®ç‹€æ…‹
router.put(&quot;/:id/status&quot;, async (req, res) =&gt; {
  const id = req.params.id;
  const { status } = req.body;
  try {
    await pool.query(&quot;UPDATE orders SET status = ? WHERE id = ?&quot;, [status, id]);
    res.json({ message: &quot;ç‹€æ…‹å·²æ›´æ–°&quot; });
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: &quot;æ›´æ–°å¤±æ•—&quot; });
  }
});

// é€šçŸ¥è²·å®¶
router.post(&quot;/:id/notify&quot;, async (req, res) =&gt; {
  const id = req.params.id;
  try {
    const [[order]] = await pool.query(&quot;SELECT * FROM orders WHERE id = ?&quot;, [id]);
    if (!order || !order.user_line_id)
      return res.status(404).json({ error: &quot;æ‰¾ä¸åˆ°è¨‚å–®æˆ–ç”¨æˆ¶&quot; });

    const text = `æ‚¨çš„è¨‚å–® ${order.order_no} ç‹€æ…‹æ›´æ–°ç‚ºï¼š${order.status}`;
    await client.pushMessage(order.user_line_id, { type: &quot;text&quot;, text });
    res.json({ message: &quot;å·²é€šçŸ¥ç”¨æˆ¶&quot; });
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: &quot;é€šçŸ¥å¤±æ•—&quot; });
  }
});

export default router;
</code></pre>
<hr>
<h1 id="ğŸ§©-C-backend-db-seed-products-sql"><a href="#ğŸ§©-C-backend-db-seed-products-sql" class="headerlink" title="ğŸ§© (C) backend/db/seed_products.sql"></a>ğŸ§© (C) <code>backend/db/seed_products.sql</code></h1><p>ğŸ‘‰ <strong>åŠŸèƒ½</strong>ï¼š<br>åˆå§‹åŒ–æ¸¬è©¦ç”¨å•†å“è³‡æ–™ã€‚</p>
<pre><code class="sql">USE line_order_db;

INSERT INTO products (name, price, description, image_url, stock)
VALUES
(&#39;ç´…è±†éºµåŒ…&#39;, 35.00, &#39;æ‰‹ä½œç´…è±†é¤¡ï¼Œæ¯æ—¥æ–°é®®å‡ºçˆ&#39;, &#39;https://i.imgur.com/LK8X4FJ.jpg&#39;, 20),
(&#39;å¥¶é…¥éºµåŒ…&#39;, 30.00, &#39;é¦™æ¿ƒå¥¶é…¥ï¼Œå…¥å£å³åŒ–&#39;, &#39;https://i.imgur.com/WR5qI1S.jpg&#39;, 20),
(&#39;æŠ¹èŒ¶æ³¢è˜¿&#39;, 40.00, &#39;æŠ¹èŒ¶é¦™æ°£æ¿ƒéƒï¼Œé…¥çš®è„†å£&#39;, &#39;https://i.imgur.com/T5Y8Msv.jpg&#39;, 20),
(&#39;å¯å¯è²æœ&#39;, 45.00, &#39;ä½ç³–å¥åº·å¯å¯è²æœ&#39;, &#39;https://i.imgur.com/W4IY1w1.jpg&#39;, 15);
</code></pre>
<hr>
<h1 id="ğŸ§©-D-frontend-src-views-Orders-vue"><a href="#ğŸ§©-D-frontend-src-views-Orders-vue" class="headerlink" title="ğŸ§© (D) frontend/src/views/Orders.vue"></a>ğŸ§© (D) <code>frontend/src/views/Orders.vue</code></h1><p>ğŸ‘‰ <strong>åŠŸèƒ½</strong>ï¼š<br>Vue å¾Œå°ç®¡ç†è¨‚å–®ï¼Œå¯é¡¯ç¤ºæ˜ç´°ã€ä¿®æ”¹ç‹€æ…‹ã€é€šçŸ¥è²·å®¶ã€‚</p>
<pre><code class="vue">&lt;template&gt;
  &lt;div class=&quot;p-6&quot;&gt;
    &lt;h2 class=&quot;text-xl font-bold mb-4&quot;&gt;ğŸ“¦ è¨‚å–®ç®¡ç†&lt;/h2&gt;
    &lt;table border=&quot;1&quot; cellpadding=&quot;8&quot;&gt;
      &lt;thead&gt;
        &lt;tr&gt;
          &lt;th&gt;ç·¨è™Ÿ&lt;/th&gt;
          &lt;th&gt;ç¸½åƒ¹&lt;/th&gt;
          &lt;th&gt;ç‹€æ…‹&lt;/th&gt;
          &lt;th&gt;æ˜ç´°&lt;/th&gt;
          &lt;th&gt;æ“ä½œ&lt;/th&gt;
        &lt;/tr&gt;
      &lt;/thead&gt;
      &lt;tbody&gt;
        &lt;tr v-for=&quot;o in orders&quot; :key=&quot;o.id&quot;&gt;
          &lt;td&gt;{{ o.order_no }}&lt;/td&gt;
          &lt;td&gt;${{ o.total_price }}&lt;/td&gt;
          &lt;td&gt;{{ o.status }}&lt;/td&gt;
          &lt;td&gt;
            &lt;ul&gt;
              &lt;li
                v-for=&quot;it in JSON.parse(o.items || &#39;[]&#39;)&quot;
                :key=&quot;it.product_id&quot;
              &gt;
                {{ it.product_name }} Ã— {{ it.qty }} = ${{ it.subtotal }}
              &lt;/li&gt;
            &lt;/ul&gt;
          &lt;/td&gt;
          &lt;td&gt;
            &lt;select v-model=&quot;o.newStatus&quot;&gt;
              &lt;option&gt;pending&lt;/option&gt;
              &lt;option&gt;confirmed&lt;/option&gt;
              &lt;option&gt;paid&lt;/option&gt;
              &lt;option&gt;shipped&lt;/option&gt;
              &lt;option&gt;completed&lt;/option&gt;
              &lt;option&gt;cancelled&lt;/option&gt;
            &lt;/select&gt;
            &lt;button @click=&quot;updateStatus(o)&quot; class=&quot;ml-2&quot;&gt;æ›´æ–°&lt;/button&gt;
            &lt;button @click=&quot;notifyUser(o.id)&quot; class=&quot;ml-2&quot;&gt;é€šçŸ¥&lt;/button&gt;
          &lt;/td&gt;
        &lt;/tr&gt;
      &lt;/tbody&gt;
    &lt;/table&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref, onMounted } from &quot;vue&quot;;
import axios from &quot;axios&quot;;

const api = &quot;http://localhost:3000/orders&quot;;
const orders = ref([]);

async function loadOrders() {
  const res = await axios.get(api);
  orders.value = res.data.map((o) =&gt; ({
    ...o,
    newStatus: o.status,
  }));
}

async function updateStatus(o) {
  await axios.put(`${api}/${o.id}/status`, { status: o.newStatus });
  await loadOrders();
}

async function notifyUser(id) {
  await axios.post(`${api}/${id}/notify`);
  alert(&quot;å·²é€šçŸ¥ç”¨æˆ¶ï¼&quot;);
}

onMounted(() =&gt; {
  loadOrders();
  setInterval(loadOrders, 10000);
});
&lt;/script&gt;

&lt;style scoped&gt;
table {
  width: 100%;
  border-collapse: collapse;
}
th {
  background: #f0f0f0;
}
button {
  background: #4caf50;
  color: white;
  border: none;
  padding: 4px 8px;
  cursor: pointer;
}
button:hover {
  background: #45a049;
}
&lt;/style&gt;
</code></pre>
<hr>
<h1 id="âœ…-æ¸¬è©¦æ­¥é©Ÿå¿«é€Ÿæ‘˜è¦"><a href="#âœ…-æ¸¬è©¦æ­¥é©Ÿå¿«é€Ÿæ‘˜è¦" class="headerlink" title="âœ… æ¸¬è©¦æ­¥é©Ÿå¿«é€Ÿæ‘˜è¦"></a>âœ… æ¸¬è©¦æ­¥é©Ÿå¿«é€Ÿæ‘˜è¦</h1><ol>
<li><p>åŒ¯å…¥ <code>seed_products.sql</code></p>
<pre><code class="bash">mysql -u root -p line_order_db &lt; backend/db/seed_products.sql
</code></pre>
</li>
<li><p>å•Ÿå‹•å¾Œç«¯ + å‰ç«¯ï¼š</p>
<pre><code class="bash">cd backend
npm run dev
ngrok http 3000   # æŠŠ ngrok URL å¡«åˆ° LINE webhook
</code></pre>
</li>
<li><p>æ‰‹æ©Ÿ LINE è¼¸å…¥ï¼šã€Œæˆ‘è¦é»é¤ã€<br>â†’ æœƒå‡ºç¾å•†å“åˆ—è¡¨<br>â†’ æŒ‰ã€Œè³¼è²·ã€å¾Œè‡ªå‹•åœ¨å¾Œå° Orders å‡ºç¾æ–°è¨‚å–®ã€‚</p>
</li>
<li><p>æ‰“é–‹å‰ç«¯ Orders.vue â†’ æ›´æ–°ç‹€æ…‹ â†’ é»ã€Œé€šçŸ¥ã€ â†’ LINE ç”¨æˆ¶æœƒæ”¶åˆ°æ¨æ’­ã€‚</p>
</li>
</ol>
<hr>
<p>æ˜¯å¦è¦æˆ‘å¹«ä½ ï¼š<br>âœ… ç”Ÿæˆä¸€ä»½å®Œæ•´ <code>.env ç¯„ä¾‹ + db_init.sql</code><br>ï¼ˆè®“ä½ ç›´æ¥å¯åœ¨ Replit æˆ–æœ¬æ©Ÿåˆå§‹åŒ– DB + LINE keyï¼‰ï¼Ÿ</p>
