<hr>
<h2 id="title-2025-07-11-Line-è¨‚å–®ç³»çµ±-C-éšæ®µ-LINE-è¨‚å–®ç³»çµ±çš„ä¸‰å¤§æ ¸å¿ƒè·¯ç”±date-2025-11-13-22-46-54categories-OneDayOneNotetags-OneNote-Lineè¨‚å–®ç³»çµ±-description-2025-07-11-Line-è¨‚å–®ç³»çµ±-C-éšæ®µ-LINE-è¨‚å–®ç³»çµ±çš„ä¸‰å¤§æ ¸å¿ƒè·¯ç”±"><a href="#title-2025-07-11-Line-è¨‚å–®ç³»çµ±-C-éšæ®µ-LINE-è¨‚å–®ç³»çµ±çš„ä¸‰å¤§æ ¸å¿ƒè·¯ç”±date-2025-11-13-22-46-54categories-OneDayOneNotetags-OneNote-Lineè¨‚å–®ç³»çµ±-description-2025-07-11-Line-è¨‚å–®ç³»çµ±-C-éšæ®µ-LINE-è¨‚å–®ç³»çµ±çš„ä¸‰å¤§æ ¸å¿ƒè·¯ç”±" class="headerlink" title="title: 2025-07-11 Line è¨‚å–®ç³»çµ±-C éšæ®µ LINE è¨‚å–®ç³»çµ±çš„ä¸‰å¤§æ ¸å¿ƒè·¯ç”±date: 2025-11-13 22:46:54categories: OneDayOneNotetags:  [OneNote, Lineè¨‚å–®ç³»çµ±]description: 2025-07-11 Line è¨‚å–®ç³»çµ±-C éšæ®µ LINE è¨‚å–®ç³»çµ±çš„ä¸‰å¤§æ ¸å¿ƒè·¯ç”±"></a>title: 2025-07-11 Line è¨‚å–®ç³»çµ±-C éšæ®µ LINE è¨‚å–®ç³»çµ±çš„ä¸‰å¤§æ ¸å¿ƒè·¯ç”±<br>date: 2025-11-13 22:46:54<br>categories: OneDayOneNote<br>tags:  [OneNote, Lineè¨‚å–®ç³»çµ±]<br>description: 2025-07-11 Line è¨‚å–®ç³»çµ±-C éšæ®µ LINE è¨‚å–®ç³»çµ±çš„ä¸‰å¤§æ ¸å¿ƒè·¯ç”±</h2><h2 id="2025-07-11-Line-è¨‚å–®ç³»çµ±-C-éšæ®µ-LINE-è¨‚å–®ç³»çµ±çš„ä¸‰å¤§æ ¸å¿ƒè·¯ç”±"><a href="#2025-07-11-Line-è¨‚å–®ç³»çµ±-C-éšæ®µ-LINE-è¨‚å–®ç³»çµ±çš„ä¸‰å¤§æ ¸å¿ƒè·¯ç”±" class="headerlink" title="2025-07-11 Line è¨‚å–®ç³»çµ±-C éšæ®µ LINE è¨‚å–®ç³»çµ±çš„ä¸‰å¤§æ ¸å¿ƒè·¯ç”±"></a>2025-07-11 Line è¨‚å–®ç³»çµ±-C éšæ®µ LINE è¨‚å–®ç³»çµ±çš„ä¸‰å¤§æ ¸å¿ƒè·¯ç”±</h2><p>ç¾åœ¨æˆ‘å€‘è¦è£œé½Šæ•´å€‹ LINE è¨‚å–®ç³»çµ±çš„ä¸‰å¤§æ ¸å¿ƒè·¯ç”±ï¼š</p>
<blockquote>
<p>ğŸ“˜ <code>/routes/productRoutes.js</code><br>ğŸ“˜ <code>/routes/userRoutes.js</code><br>ğŸ“˜ <code>/routes/lineWebhook.js</code></p>
</blockquote>
<p>é€™ä¸‰å€‹æª”æ¡ˆå®Œæˆå¾Œï¼Œä½ çš„ Node.js å°ˆæ¡ˆå°±èƒ½ï¼š</p>
<ul>
<li>ç®¡ç†å•†å“èˆ‡ä½¿ç”¨è€…</li>
<li>æ¥æ”¶ LINE webhook äº‹ä»¶</li>
<li>èˆ‡è¨‚å–® API ä¸²æ¥å®Œæˆã€Œå¯äº’å‹•çš„ LINE è¨‚å–®ç³»çµ±ã€ğŸ¯</li>
</ul>
<hr>
<h2 id="ğŸ›ï¸-ä¸€ã€productRoutes-js"><a href="#ğŸ›ï¸-ä¸€ã€productRoutes-js" class="headerlink" title="ğŸ›ï¸ ä¸€ã€productRoutes.js"></a>ğŸ›ï¸ ä¸€ã€<code>productRoutes.js</code></h2><blockquote>
<p>ğŸ“ è·¯å¾‘ï¼š<code>/backend/routes/productRoutes.js</code></p>
</blockquote>
<pre><code class="js">// ===============================
// ğŸ›ï¸ productRoutes.js
// å•†å“ç®¡ç† API
// ===============================
import express from &quot;express&quot;;
import { query } from &quot;../db.js&quot;;

const router = express.Router();

// âœ… å–å¾—æ‰€æœ‰å•†å“
router.get(&quot;/&quot;, async (req, res) =&gt; {
  try {
    const products = await query(&quot;SELECT * FROM products ORDER BY id DESC&quot;);
    res.json(products);
  } catch (err) {
    console.error(&quot;Error fetching products:&quot;, err);
    res.status(500).json({ error: &quot;Server error while fetching products&quot; });
  }
});

// âœ… æ–°å¢å•†å“
router.post(&quot;/&quot;, async (req, res) =&gt; {
  try {
    const { name, description, price, stock, category } = req.body;
    await query(
      &quot;INSERT INTO products (name, description, price, stock, category) VALUES (?, ?, ?, ?, ?)&quot;,
      [name, description, price, stock, category]
    );
    res.status(201).json({ message: &quot;Product created successfully&quot; });
  } catch (err) {
    console.error(&quot;Error adding product:&quot;, err);
    res.status(500).json({ error: &quot;Server error while adding product&quot; });
  }
});

// âœ… æ›´æ–°å•†å“
router.patch(&quot;/:id&quot;, async (req, res) =&gt; {
  try {
    const id = req.params.id;
    const { name, description, price, stock, category } = req.body;
    await query(
      &quot;UPDATE products SET name=?, description=?, price=?, stock=?, category=? WHERE id=?&quot;,
      [name, description, price, stock, category, id]
    );
    res.json({ message: &quot;Product updated successfully&quot; });
  } catch (err) {
    console.error(&quot;Error updating product:&quot;, err);
    res.status(500).json({ error: &quot;Failed to update product&quot; });
  }
});

// âœ… åˆªé™¤å•†å“
router.delete(&quot;/:id&quot;, async (req, res) =&gt; {
  try {
    const id = req.params.id;
    await query(&quot;DELETE FROM products WHERE id=?&quot;, [id]);
    res.json({ message: &quot;Product deleted successfully&quot; });
  } catch (err) {
    console.error(&quot;Error deleting product:&quot;, err);
    res.status(500).json({ error: &quot;Failed to delete product&quot; });
  }
});

export default router;
</code></pre>
<hr>
<h2 id="ğŸ‘¤-äºŒã€userRoutes-js"><a href="#ğŸ‘¤-äºŒã€userRoutes-js" class="headerlink" title="ğŸ‘¤ äºŒã€userRoutes.js"></a>ğŸ‘¤ äºŒã€<code>userRoutes.js</code></h2><blockquote>
<p>ğŸ“ è·¯å¾‘ï¼š<code>/backend/routes/userRoutes.js</code></p>
</blockquote>
<p>é€™è£¡çš„ä½¿ç”¨è€…ä¸»è¦æ˜¯ <strong>LINE ä½¿ç”¨è€…</strong>ï¼Œ<br>æˆ‘å€‘è®“ä»–èƒ½å¤ æŸ¥è©¢ã€è¨»å†Šèˆ‡æ›´æ–°å€‹äººè³‡æ–™ã€‚</p>
<pre><code class="js">// ===============================
// ğŸ‘¤ userRoutes.js
// ä½¿ç”¨è€…ç®¡ç† API
// ===============================
import express from &quot;express&quot;;
import { query } from &quot;../db.js&quot;;

const router = express.Router();

// âœ… æŸ¥è©¢æ‰€æœ‰ä½¿ç”¨è€…
router.get(&quot;/&quot;, async (req, res) =&gt; {
  try {
    const users = await query(&quot;SELECT * FROM users ORDER BY id DESC&quot;);
    res.json(users);
  } catch (err) {
    console.error(&quot;Error fetching users:&quot;, err);
    res.status(500).json({ error: &quot;Server error while fetching users&quot; });
  }
});

// âœ… æ–°å¢æˆ–æ›´æ–° LINE ä½¿ç”¨è€…
router.post(&quot;/register&quot;, async (req, res) =&gt; {
  try {
    const { line_user_id, display_name, phone, email } = req.body;

    const existing = await query(
      &quot;SELECT id FROM users WHERE line_user_id = ?&quot;,
      [line_user_id]
    );

    if (existing.length &gt; 0) {
      // æ›´æ–°è³‡æ–™
      await query(
        &quot;UPDATE users SET display_name=?, phone=?, email=? WHERE line_user_id=?&quot;,
        [display_name, phone, email, line_user_id]
      );
      res.json({ message: &quot;User updated&quot; });
    } else {
      // æ–°å¢ä½¿ç”¨è€…
      await query(
        &quot;INSERT INTO users (line_user_id, display_name, phone, email) VALUES (?, ?, ?, ?)&quot;,
        [line_user_id, display_name, phone, email]
      );
      res.status(201).json({ message: &quot;User registered&quot; });
    }
  } catch (err) {
    console.error(&quot;Error registering user:&quot;, err);
    res.status(500).json({ error: &quot;Failed to register user&quot; });
  }
});

export default router;
</code></pre>
<hr>
<h2 id="ğŸ’¬-ä¸‰ã€lineWebhook-js"><a href="#ğŸ’¬-ä¸‰ã€lineWebhook-js" class="headerlink" title="ğŸ’¬ ä¸‰ã€lineWebhook.js"></a>ğŸ’¬ ä¸‰ã€<code>lineWebhook.js</code></h2><blockquote>
<p>ğŸ“ è·¯å¾‘ï¼š<code>/backend/routes/lineWebhook.js</code></p>
</blockquote>
<p>é€™æ˜¯æ•´å€‹ LINE Bot çš„æ ¸å¿ƒå…¥å£ï¼š</p>
<ul>
<li>æ¥æ”¶ä½¿ç”¨è€…è¨Šæ¯äº‹ä»¶</li>
<li>å„²å­˜è¨Šæ¯åˆ° DB</li>
<li>å¯å›è¦†è¨Šæ¯æˆ–è§¸ç™¼è¨‚å–®æµç¨‹</li>
</ul>
<p>è«‹å…ˆå®‰è£ LINE SDKï¼š</p>
<pre><code class="bash">npm install @line/bot-sdk
</code></pre>
<p>ç„¶å¾Œå»ºç«‹ä»¥ä¸‹å…§å®¹ğŸ‘‡</p>
<pre><code class="js">// ===============================
// ğŸ’¬ lineWebhook.js
// LINE Bot Webhook API
// ===============================
import express from &quot;express&quot;;
import line from &quot;@line/bot-sdk&quot;;
import { query } from &quot;../db.js&quot;;
import config from &quot;../config.js&quot;;

const router = express.Router();

// LINE SDK è¨­å®š
const lineConfig = {
  channelSecret: config.line.channelSecret,
  channelAccessToken: config.line.channelAccessToken,
};

const client = new line.Client(lineConfig);

// âœ… æ¥æ”¶ LINE webhook
router.post(config.line.webhookPath, line.middleware(lineConfig), async (req, res) =&gt; {
  Promise.all(req.body.events.map(handleEvent))
    .then((result) =&gt; res.json(result))
    .catch((err) =&gt; {
      console.error(&quot;âŒ Webhook Error:&quot;, err);
      res.status(500).end();
    });
});

// è™•ç†å„é¡äº‹ä»¶
async function handleEvent(event) {
  console.log(&quot;ğŸ”¹ Received Event:&quot;, event);

  // åªè™•ç† message äº‹ä»¶
  if (event.type !== &quot;message&quot; || event.message.type !== &quot;text&quot;) {
    return Promise.resolve(null);
  }

  const userId = event.source.userId;
  const messageText = event.message.text;

  // å„²å­˜è¨Šæ¯åˆ° DB
  await saveMessage(userId, messageText);

  // ç¯„ä¾‹ï¼šç•¶ä½¿ç”¨è€…è¼¸å…¥ã€Œèœå–®ã€æ™‚ï¼Œåˆ—å‡ºå•†å“
  if (messageText === &quot;èœå–®&quot; || messageText === &quot;menu&quot;) {
    const products = await query(&quot;SELECT name, price FROM products&quot;);
    const replyText = products
      .map((p) =&gt; `${p.name} - $${p.price}`)
      .join(&quot;\n&quot;);

    return client.replyMessage(event.replyToken, {
      type: &quot;text&quot;,
      text: `ğŸ“‹ ä»Šæ—¥èœå–®ï¼š\n${replyText}`,
    });
  }

  // ç¯„ä¾‹ï¼šå›è¦†æ”¶åˆ°è¨Šæ¯
  return client.replyMessage(event.replyToken, {
    type: &quot;text&quot;,
    text: `ä½ èªªäº†ï¼šã€Œ${messageText}ã€`,
  });
}

// å„²å­˜è¨Šæ¯åˆ°è³‡æ–™åº«
async function saveMessage(line_user_id, text) {
  try {
    // ç¢ºä¿ä½¿ç”¨è€…å­˜åœ¨
    const user = await query(&quot;SELECT id FROM users WHERE line_user_id=?&quot;, [line_user_id]);
    let userId;
    if (user.length === 0) {
      const res = await query(
        &quot;INSERT INTO users (line_user_id, display_name) VALUES (?, ?)&quot;,
        [line_user_id, &quot;LINE_USER&quot;]
      );
      userId = res.insertId;
    } else {
      userId = user[0].id;
    }

    // å„²å­˜è¨Šæ¯
    await query(&quot;INSERT INTO message_log (user_id, message_text, message_type) VALUES (?, ?, &#39;text&#39;)&quot;, [
      userId,
      text,
    ]);
  } catch (err) {
    console.error(&quot;Error saving message:&quot;, err);
  }
}

export default router;
</code></pre>
<hr>
<h2 id="âš™ï¸-å››ã€æ•´åˆåˆ°ä¸»ä¼ºæœå™¨-server-js"><a href="#âš™ï¸-å››ã€æ•´åˆåˆ°ä¸»ä¼ºæœå™¨-server-js" class="headerlink" title="âš™ï¸ å››ã€æ•´åˆåˆ°ä¸»ä¼ºæœå™¨ server.js"></a>âš™ï¸ å››ã€æ•´åˆåˆ°ä¸»ä¼ºæœå™¨ <code>server.js</code></h2><pre><code class="js">import express from &quot;express&quot;;
import cors from &quot;cors&quot;;
import config from &quot;./config.js&quot;;
import { initDB } from &quot;./db.js&quot;;

import productRoutes from &quot;./routes/productRoutes.js&quot;;
import orderRoutes from &quot;./routes/orderRoutes.js&quot;;
import userRoutes from &quot;./routes/userRoutes.js&quot;;
import lineWebhook from &quot;./routes/lineWebhook.js&quot;;

const app = express();
app.use(cors());
app.use(express.json());

// è¨»å†Šè·¯ç”±
app.use(&quot;/api/products&quot;, productRoutes);
app.use(&quot;/api/orders&quot;, orderRoutes);
app.use(&quot;/api/users&quot;, userRoutes);
app.use(&quot;/&quot;, lineWebhook); // webhook è·¯ç”±å¿…é ˆæ”¾åœ¨æ ¹ç›®éŒ„

// å•Ÿå‹•ä¼ºæœå™¨
initDB().then(() =&gt; {
  app.listen(config.port, () =&gt; {
    console.log(`ğŸš€ Server running on http://localhost:${config.port}`);
  });
});
</code></pre>
<hr>
<h2 id="âœ…-æ¸¬è©¦é‡é»æ•´ç†"><a href="#âœ…-æ¸¬è©¦é‡é»æ•´ç†" class="headerlink" title="âœ… æ¸¬è©¦é‡é»æ•´ç†"></a>âœ… æ¸¬è©¦é‡é»æ•´ç†</h2><table>
<thead>
<tr>
<th>æ¸¬è©¦é …ç›®</th>
<th>æ–¹æ³•</th>
<th>èªªæ˜</th>
</tr>
</thead>
<tbody><tr>
<td>æ¸¬è©¦ LINE webhook</td>
<td>LINE Developer â†’ Webhook Test</td>
<td>æª¢æŸ¥ä¼ºæœå™¨èƒ½æ”¶åˆ°äº‹ä»¶</td>
</tr>
<tr>
<td>æŸ¥è©¢å•†å“</td>
<td>GET &#x2F;api&#x2F;products</td>
<td>æ‡‰å›å‚³å•†å“åˆ—è¡¨</td>
</tr>
<tr>
<td>æ–°å¢å•†å“</td>
<td>POST &#x2F;api&#x2F;products</td>
<td>æ‡‰å»ºç«‹æ–°å•†å“</td>
</tr>
<tr>
<td>æŸ¥è©¢è¨‚å–®</td>
<td>GET &#x2F;api&#x2F;orders</td>
<td>æ‡‰å›å‚³è¨‚å–®åˆ—è¡¨</td>
</tr>
<tr>
<td>å»ºç«‹è¨‚å–®</td>
<td>POST &#x2F;api&#x2F;orders</td>
<td>å»ºç«‹æ–°è¨‚å–®èˆ‡æ˜ç´°</td>
</tr>
<tr>
<td>è¨»å†Šä½¿ç”¨è€…</td>
<td>POST &#x2F;api&#x2F;users&#x2F;register</td>
<td>æ–°å¢æˆ–æ›´æ–° LINE user</td>
</tr>
</tbody></table>
<hr>
<p>å¦‚æœä½ é¡˜æ„ï¼Œæˆ‘å¯ä»¥å¹«ä½ æ¥è‘—å»ºç«‹ï¼š</p>
<blockquote>
<p>ğŸ“— <code>frontend (Vue3)</code> å°æ‡‰çš„ç®¡ç†ä»‹é¢æ¨¡çµ„<br>åŒ…å«ï¼šå•†å“ç®¡ç†é ã€è¨‚å–®åˆ—è¡¨ã€LINE Bot è¨Šæ¯æ¨¡æ“¬å™¨ï¼ˆæ–¹ä¾¿é–‹ç™¼æ™‚æ¸¬è©¦ï¼‰</p>
</blockquote>
<p>æ˜¯å¦è¦æˆ‘æ¥è‘—å¹«ä½ ç”Ÿæˆ Vue3 å‰ç«¯éƒ¨åˆ†ï¼Ÿ</p>
