<hr>
<h2 id="title-2025-06-12-把「Mac-作為中介（MCP-server）、同時連-ChatGPT（OpenAI）與-DeepSeek」的角色date-2025-10-01-23-02-46categories-OneDayOneNotetags-MVP-MCP-Node-description-2025-06-12-把「Mac-作為中介（MCP-server）、同時連-ChatGPT（OpenAI）與-DeepSeek」的角色"><a href="#title-2025-06-12-把「Mac-作為中介（MCP-server）、同時連-ChatGPT（OpenAI）與-DeepSeek」的角色date-2025-10-01-23-02-46categories-OneDayOneNotetags-MVP-MCP-Node-description-2025-06-12-把「Mac-作為中介（MCP-server）、同時連-ChatGPT（OpenAI）與-DeepSeek」的角色" class="headerlink" title="title: 2025-06-12 把「Mac 作為中介（MCP server）、同時連 ChatGPT（OpenAI）與 DeepSeek」的角色date: 2025-10-01 23:02:46categories: OneDayOneNotetags:  [MVP,MCP,Node]description: 2025-06-12 把「Mac 作為中介（MCP server）、同時連 ChatGPT（OpenAI）與 DeepSeek」的角色"></a>title: 2025-06-12 把「Mac 作為中介（MCP server）、同時連 ChatGPT（OpenAI）與 DeepSeek」的角色<br>date: 2025-10-01 23:02:46<br>categories: OneDayOneNote<br>tags:  [MVP,MCP,Node]<br>description: 2025-06-12 把「Mac 作為中介（MCP server）、同時連 ChatGPT（OpenAI）與 DeepSeek」的角色</h2><h2 id="2025-06-12-把「Mac-作為中介（MCP-server）、同時連-ChatGPT（OpenAI）與-DeepSeek」的角色"><a href="#2025-06-12-把「Mac-作為中介（MCP-server）、同時連-ChatGPT（OpenAI）與-DeepSeek」的角色" class="headerlink" title="2025-06-12 把「Mac 作為中介（MCP server）、同時連 ChatGPT（OpenAI）與 DeepSeek」的角色"></a>2025-06-12 把「Mac 作為中介（MCP server）、同時連 ChatGPT（OpenAI）與 DeepSeek」的角色</h2><p>好 — 我來把「<strong>Mac 作為中介（MCP server）</strong>、同時連 ChatGPT（OpenAI）與 DeepSeek」的角色、資料流、最小可運作範例與測試步驟，一次清楚且分步說明給你。你要一步步做就行，我把每步拆得很小、可驗收。</p>
<h1 id="先說重點（短）"><a href="#先說重點（短）" class="headerlink" title="先說重點（短）"></a>先說重點（短）</h1><ul>
<li><strong>Mac（MCP server）＝中介 &#x2F; 多供應商 Gateway</strong>：前端或其他機器把使用者請求丟給 Mac（MCP），MCP 決定要呼叫哪一家（OpenAI 或 DeepSeek），呼叫後把結果回給前端，並可同步存到 DB（放在 Windows 或雲端）。</li>
<li>你的 Mac 並不做大量推理；它只做路由、adapter、轉格式、審查、logging 與 failover。這樣可把重資源工作放在雲端供應商，舊 Mac 也能跑得順。</li>
</ul>
<h1 id="高階資料流（簡圖）"><a href="#高階資料流（簡圖）" class="headerlink" title="高階資料流（簡圖）"></a>高階資料流（簡圖）</h1><p>Frontend ←→ Mac(MCP gateway) ←→ { OpenAI (ChatGPT API), DeepSeek API }<br>↑<br>DB（在 Windows &#x2F; 雲端）</p>
<h1 id="最小可運作步驟（3-個小步驟，先做第一個）"><a href="#最小可運作步驟（3-個小步驟，先做第一個）" class="headerlink" title="最小可運作步驟（3 個小步驟，先做第一個）"></a>最小可運作步驟（3 個小步驟，先做第一個）</h1><p>我把整個工作分成三小步，你先只做第 1。</p>
<h2 id="Step-1（先做）-—-在-Mac-建最簡-Gateway-並測試能呼叫兩個-provider（用-mock-或實-API）"><a href="#Step-1（先做）-—-在-Mac-建最簡-Gateway-並測試能呼叫兩個-provider（用-mock-或實-API）" class="headerlink" title="Step 1（先做） — 在 Mac 建最簡 Gateway 並測試能呼叫兩個 provider（用 mock 或實 API）"></a>Step 1（先做） — 在 Mac 建最簡 Gateway 並測試能呼叫兩個 provider（用 mock 或實 API）</h2><p>目的：讓 Mac 能接受前端請求並呼叫不同 provider（可先 mock DeepSeek &#x2F; OpenAI 回應做測試）</p>
<ol>
<li>在 Mac 建資料夾並安裝 node（若已安裝可跳過）</li>
</ol>
<pre><code class="bash">mkdir ~/mcp-gateway
cd ~/mcp-gateway
npm init -y
npm i express dotenv node-fetch
# node-fetch for fetch in Node &lt;18 ; 若 Node18+ 可直接用全域 fetch
</code></pre>
<ol start="2">
<li>新增 <code>.env</code>（請放在 Mac，不要放前端）</li>
</ol>
<pre><code>OPENAI_API_KEY=sk-xxxx
DEEPSEEK_API_KEY=ds-xxxx
PORT=4000
</code></pre>
<ol start="3">
<li>建 <code>gateway.mjs</code>（最小版，多 provider adapter + failover） — 先貼這份到 Mac：</li>
</ol>
<pre><code class="js">// gateway.mjs (最小可運作範例)
import express from &#39;express&#39;;
import dotenv from &#39;dotenv&#39;;
dotenv.config();
const app = express();
app.use(express.json());

const OPENAI_KEY = process.env.OPENAI_API_KEY || &#39;&#39;;
const DEEPSEEK_KEY = process.env.DEEPSEEK_API_KEY || &#39;&#39;;

// provider adapters
const providers = {
  openai: async ({ messages, opts }) =&gt; {
    // real OpenAI call (示意) - 如果沒 key, 回 mock
    if (!OPENAI_KEY) return { text: &#39;[mock openai] 回傳範例&#39; };
    const resp = await fetch(&#39;https://api.openai.com/v1/chat/completions&#39;, {
      method: &#39;POST&#39;,
      headers: {
        &#39;Authorization&#39;: `Bearer ${OPENAI_KEY}`,
        &#39;Content-Type&#39;: &#39;application/json&#39;
      },
      body: JSON.stringify({
        model: opts?.model || &#39;gpt-3.5-turbo&#39;,
        messages
      })
    });
    const data = await resp.json();
    return { text: data?.choices?.[0]?.message?.content ?? &#39;&#39;, raw: data };
  },

  deepseek: async ({ messages, opts }) =&gt; {
    // real DeepSeek call (示意) - 若沒 key，回 mock
    if (!DEEPSEEK_KEY) return { text: &#39;[mock deepseek] 回傳範例&#39; };
    const resp = await fetch(&#39;https://api.deepseek.com/v1/chat/completions&#39;, {
      method: &#39;POST&#39;,
      headers: {
        &#39;Authorization&#39;: `Bearer ${DEEPSEEK_KEY}`,
        &#39;Content-Type&#39;: &#39;application/json&#39;
      },
      body: JSON.stringify({
        model: opts?.model || &#39;deepseek-v1&#39;,
        messages
      })
    });
    const data = await resp.json();
    return { text: data?.choices?.[0]?.message?.content ?? &#39;&#39;, raw: data };
  }
};

// health
app.get(&#39;/health&#39;, (req, res) =&gt; res.json({ status: &#39;ok&#39;, role: &#39;mcp-gateway&#39; }));

// main endpoint
app.post(&#39;/api/chat&#39;, async (req, res) =&gt; {
  const { provider = &#39;openai&#39;, messages = [{ role:&#39;user&#39;, content: &#39;hello&#39; }], opts } = req.body;
  const adapter = providers[provider];
  if (!adapter) return res.status(400).json({ error: &#39;unknown provider&#39; });

  try {
    const { text, raw } = await adapter({ messages, opts });
    // 這裡可加入：存 DB / 審查 / 計費
    return res.json({ provider, text, raw });
  } catch (err) {
    console.error(&#39;provider error:&#39;, err);
    // 簡單 failover：若 openai 失敗則嘗試 deepseek（或反之）
    const fallback = provider === &#39;openai&#39; ? providers[&#39;deepseek&#39;] : providers[&#39;openai&#39;];
    try {
      const fallbackResp = await fallback({ messages, opts });
      return res.json({ provider: provider + &#39;_fallback&#39;, text: fallbackResp.text, raw: fallbackResp.raw });
    } catch (err2) {
      console.error(&#39;fallback failed:&#39;, err2);
      return res.status(500).json({ error: &#39;all providers failed&#39; });
    }
  }
});

const port = process.env.PORT || 4000;
app.listen(port, () =&gt; console.log(`MCP gateway listening on ${port}`));
</code></pre>
<ol start="4">
<li>啟動並測試（本地）</li>
</ol>
<pre><code class="bash">node gateway.mjs
# 在同一台 MAC 測試
curl -X POST http://localhost:4000/api/chat -H &quot;Content-Type: application/json&quot; -d &#39;{&quot;provider&quot;:&quot;openai&quot;,&quot;messages&quot;:[{&quot;role&quot;:&quot;user&quot;,&quot;content&quot;:&quot;哈囉&quot;}] }&#39;
# 或 test deepseek
curl -X POST http://localhost:4000/api/chat -H &quot;Content-Type: application/json&quot; -d &#39;{&quot;provider&quot;:&quot;deepseek&quot;,&quot;messages&quot;:[{&quot;role&quot;:&quot;user&quot;,&quot;content&quot;:&quot;哈囉&quot;}] }&#39;
</code></pre>
<ul>
<li>如果你沒放 API keys，會看到 mock 回覆（<code>[mock ...]</code>），這對測試路由很方便。</li>
</ul>
<p><strong>驗收條件（Step 1 完成）</strong></p>
<ul>
<li>在 Mac 上能啟動 <code>gateway.mjs</code> 並成功回應 <code>/health</code>。</li>
<li><code>POST /api/chat</code> 能對 <code>provider=openai</code> 與 <code>provider=deepseek</code> 回應（mock 或真實回覆皆可）。</li>
<li>若你在 Windows（或前端機）用 <code>curl http://&lt;mac-ip&gt;:4000/health</code> 能拿到回應（檢查 LAN 能通）。</li>
</ul>
<hr>
<h2 id="Step-2（完成-Step1-再做）-—-把-DB-放到-Windows，並讓-Mac-把每次對話儲存到-DB"><a href="#Step-2（完成-Step1-再做）-—-把-DB-放到-Windows，並讓-Mac-把每次對話儲存到-DB" class="headerlink" title="Step 2（完成 Step1 再做） — 把 DB 放到 Windows，並讓 Mac 把每次對話儲存到 DB"></a>Step 2（完成 Step1 再做） — 把 DB 放到 Windows，並讓 Mac 把每次對話儲存到 DB</h2><p>（我會給你 MySQL SQL 與如何在 Mac 用 <code>mysql2</code> 存入的最小範例。這一步我會再拆成小動作給你，等你說 Step1 OK 我再貼 Step2）</p>
<h2 id="Step-3（之後）-—-加入-moderation-stream-UI-與-provider-選單（再拆細）"><a href="#Step-3（之後）-—-加入-moderation-stream-UI-與-provider-選單（再拆細）" class="headerlink" title="Step 3（之後） — 加入 moderation &#x2F; stream &#x2F; UI 與 provider 選單（再拆細）"></a>Step 3（之後） — 加入 moderation &#x2F; stream &#x2F; UI 與 provider 選單（再拆細）</h2><hr>
<h1 id="實務配置建議（快速清單）"><a href="#實務配置建議（快速清單）" class="headerlink" title="實務配置建議（快速清單）"></a>實務配置建議（快速清單）</h1><ul>
<li>把 <strong>API keys 放在 Mac 的 .env</strong>（不要放前端）。</li>
<li>Mac 設為固定 LAN IP（router DHCP 保留），方便 Windows 或手機前端呼叫。</li>
<li>Mac 用 <code>pm2</code> 常駐 gateway：<code>pm2 start gateway.mjs --name mcp-gateway</code>。</li>
<li>日誌：在 gateway 實作簡單 request logger（winston 或檔案），以利除錯與計費。</li>
<li>安全：若要在 Internet 上測試，先用 ngrok 做測試隧道再做正式 port-forward；正式上線再放 WAF &#x2F; auth。</li>
<li>Failover 策略：優先 provider 與 fallback provider 明確寫在 config（例如 default&#x3D;openai, fallback&#x3D;deepseek）。</li>
</ul>
<h1 id="小提醒（你可能會問）"><a href="#小提醒（你可能會問）" class="headerlink" title="小提醒（你可能會問）"></a>小提醒（你可能會問）</h1><ul>
<li>「Mac 是中介」表示它<strong>不需要</strong>跑大型模型；請把 heavy compute 留給雲端（OpenAI&#x2F;DeepSeek）。</li>
<li>若 DeepSeek API 路徑或參數變了，請以該服務官方文件為準；我可以幫你把 adapter 調整成最新格式（你貼官方 doc 或告訴我有哪個錯誤即可）。</li>
</ul>
<hr>
<p>想先做哪一步？</p>
<ol>
<li>你說「我現在要先做 Step1（在 Mac 上啟動 gateway.mjs 並測試）」，我就給你要執行的確切命令與排錯方式。</li>
<li>或直接把你現有的 <code>gateway</code> 程式碼貼上，我直接幫你修改成同時支援 OpenAI + DeepSeek 的 adapter（可直接貼上執行）。</li>
</ol>
<p>你選一個，我立刻把下一個可直接貼上執行的內容給你。</p>
